(function(){function e(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}var t,n;(t=function(t){var n=this;return null==t&&(t={}),this.root="string"==typeof t.root?document.querySelector(t.root):t.root,this.root||console.warn("[uploadr] warning: no node found for root ",t.root),this.evtHandler={},this.opt=e({},t),this.opt.provider=t.provider||{host:"native",config:{route:"/d/uploadr"}},this.progress=function(e){var t,r;if((t=(e.item||(e.item={})).node)&&(r=ld$.find(t,"[ld=progress]")[0]))return r.style.width=100*e.percent+"%",e.percent>=1?debounce(500).then(function(){var r;if(ld$.remove(t),~(r=n.lc.files.indexOf(e.item)))return n.lc.files.splice(r,1)}):void 0},this.lc={files:[]},this.init=proxise.once(function(){return n._init()}),this.init(),this}).prototype=e(Object.create(Object.prototype),{on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){var t,n,r,i,o,u,c,a=[];for(n=[],r=1,i=arguments.length;r<i;++r)n.push(arguments[r]);for(t=n,r=0,u=(o=this.evtHandler[e]||[]).length;r<u;++r)c=o[r],a.push(c.apply(this,t));return a},_init:function(){var t=this;return Promise.resolve().then(function(){var n,r,i,o;return n=t.lc,r=function(r){var i,u;return i=o.get("preview"),u=r.map(function(t){return new Promise(function(n,r){var o;return o=new Image,o.onload=function(){var r,u;return i&&((r=i.style).backgroundImage="url("+t.thumb+")",r.width=o.width+"px",r.height=o.height+"px"),n(e((u={},u.width=o.width,u.height=o.height,u),t))},o.src=t.thumb})}),Promise.all(u).then(function(){return n.files=(n.files||[]).concat(r),debounce(500)}).then(function(){return o.render(),t.fire("preview.done"),t.lc.loader.off(),t.fire("file.chosen",n.files)})},i=function(e){return t.fire("preview.loading"),t.lc.loader.on(),e=Array.from(e),new Promise(function(t,n){var i,o;return i=[],(o=function(e){var n,u,c;return(n=e.splice(0,1)[0])?(u=URL.createObjectURL(n),c=new Image,c.onload=function(){var t,u,a,l;return t=[c.width,c.height],u=t[0],a=t[1],u>200&&(u=(t=[200,200*a/u])[0],a=t[1]),a>150&&(u=(t=[150*u/a,150])[0],a=t[1]),l=document.createElement("canvas"),l.width=u,l.height=a,l.getContext("2d").drawImage(c,0,0,u,a),l.toBlob(function(t){var u;return i.push(u={thumb:URL.createObjectURL(t),file:n}),r([u]),o(e)})},c.src=u):t(i)})(e)})},t.lc.view=o=new ldView({root:t.root,action:{input:{input:function(e){var t;return t=e.node,e.evt,i(t.files).then(function(e){var n;if(t.value=null,n=t.form)return n.reset()})}},click:{upload:function(e){return e.node,e.evt,t.upload().then(function(e){return t.clear(),e})},clear:function(e){return e.node,e.evt,t.clear()}},drop:{drop:function(e){var t;return e.node,(t=e.evt).preventDefault(),i(t.dataTransfer.files)}},dragover:{drop:function(e){return e.node,e.evt.preventDefault()}}},init:{loader:function(e){var n;return n=e.node,t.lc.loader=new ldLoader({root:n})}},handler:{file:{list:function(){return n.files||[]},view:{action:{click:{delete:function(e){var t,r;if(t=e.context,~(r=n.files.indexOf(t)))return n.files.splice(r,1),n.view.render("file")}}},handler:{name:function(e){var t,n;return t=e.node,n=e.context,t.textContent=n.file.name},size:function(e){var t,n;return t=e.node,n=e.context,t.textContent=Math.round(n.file.size/1024)+"KB"},thumb:function(e){var t,n;return t=e.node,n=e.context,"img"===t.nodeName.toLowerCase()?t.setAttribute("src",n.thumb):t.style.backgroundImage="url("+n.thumb+")"}}}}}})})},get:function(){return this.lc.files},clear:function(){return this.lc.files.splice(0),this.lc.view.render()},upload:function(){var e=this;return n[this.opt.provider.host]({files:this.lc.files,progress:this.progress,opt:this.opt.provider.config}).then(function(t){return e.fire("upload.done",t),t}).catch(function(t){return e.fire("upload.fail",t),Promise.reject(t)})}}),t.ext=n={},(t.viewer=function(e){var t,n,r=this;return this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.root||console.warn("[uploadr] warning: no node found for root ",e.root),this.evtHandler={},this.lc=t={},this.files=t.files=[],this.view=n=new ldView({root:this.root,action:{click:{list:function(e){var t,n,i,o;if(t=e.node,n=e.evt,i=ld$.parent(n.target,"[data-src]",t))return o=i.getAttribute("data-src"),r.fire("choose",{url:o})}}},handler:{file:{list:function(){return t.files||[]},key:function(e){return e._id},view:{text:{size:function(e){e.context},name:function(e){e.context}},handler:{thumb:function(e){var t,n;if(t=e.node,n=e.context,t._load!==n.url)return t._load=n.url,t.style.opacity=0,"img"===t.nodeName.toLowerCase()?(t.setAttribute("src",n.url),t.onload=function(){return ld$.find(t.parentNode,"div[ld=thumb]").map(function(e){return e.style.opacity=1})}):t.style.backgroundImage="url("+n.url+")",t.setAttribute("data-src",n.url)}}}}}}),this.page=e.page instanceof ldPage?e.page:new ldPage(e.page||{}),this.page.init(),this.page.on("fetch",function(e){var i;return i=e.map(function(e){return e._id=Math.random(),e}),t.files=t.files.concat(i),n.render(),r.fire("fetch",i)}),this.page.on("finish",function(){return r.fire("finish")}),this.page.on("empty",function(){return r.fire("empty")}),this}).prototype=e(Object.create(Object.prototype),{on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){var t,n,r,i,o,u,c,a=[];for(n=[],r=1,i=arguments.length;r<i;++r)n.push(arguments[r]);for(t=n,r=0,u=(o=this.evtHandler[e]||[]).length;r<u;++r)c=o[r],a.push(c.apply(this,t));return a},fetch:function(){return this.page.fetch()},reset:function(){return this.page.reset(),this.lc.files=[],this.view.render()}}),"undefined"!=typeof module&&null!==module?module.exports=t:"undefined"!=typeof window&&null!==window&&(window.uploadr=t)}).call(this);
