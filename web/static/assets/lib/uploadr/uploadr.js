// Generated by LiveScript 1.3.1
var slice$ = [].slice;
(function(){
  var viewer, that, uploadr, ext;
  viewer = (that = (window.uploadr || (window.uploadr = {})).viewer) ? that : null;
  uploadr = function(opt){
    var this$ = this;
    opt == null && (opt = {});
    this.root = typeof opt.root === 'string'
      ? document.querySelector(opt.root)
      : opt.root;
    if (!this.root) {
      console.warn("[uploadr] warning: no node found for root ", opt.root);
    }
    this.evtHandler = {};
    this.opt = opt;
    this.ucfg = opt.uploader || {
      route: '/d/uploadr',
      host: 'native'
    };
    this.progress = function(v){
      var n, p;
      if (!(n = (v.item || (v.item = {})).node)) {
        return;
      }
      if (!(p = ld$.find(n, '[ld=progress]')[0])) {
        return;
      }
      p.style.width = v.percent * 100 + "%";
      if (v.percent >= 1) {
        return debounce(500).then(function(){
          var i;
          ld$.remove(n);
          if (~(i = this$.lc.files.indexOf(v.item))) {
            return this$.lc.files.splice(i, 1);
          }
        });
      }
    };
    this.lc = {
      files: []
    };
    this.init();
    return this;
  };
  uploadr.prototype = import$(Object.create(Object.prototype), {
    on: function(n, cb){
      var ref$;
      return ((ref$ = this.evtHandler)[n] || (ref$[n] = [])).push(cb);
    },
    fire: function(n){
      var v, i$, ref$, len$, cb, results$ = [];
      v = slice$.call(arguments, 1);
      for (i$ = 0, len$ = (ref$ = this.evtHandler[n] || []).length; i$ < len$; ++i$) {
        cb = ref$[i$];
        results$.push(cb.apply(this, v));
      }
      return results$;
    },
    init: function(){
      var lc, preview, view, this$ = this;
      lc = this.lc;
      preview = function(files){
        var preview, promises;
        preview = view.get('preview');
        promises = files.map(function(file){
          return new Promise(function(res, rej){
            var img;
            img = new Image;
            img.onload = function(){
              var x$, ref$;
              if (preview) {
                x$ = preview.style;
                x$.backgroundImage = "url(" + file.thumb + ")";
                x$.width = img.width + "px";
                x$.height = img.height + "px";
              }
              return res(import$((ref$ = {}, ref$.width = img.width, ref$.height = img.height, ref$), file));
            };
            return img.src = file.thumb;
          });
        });
        return Promise.all(promises).then(function(){
          lc.files = (lc.files || []).concat(files);
          return debounce(500);
        }).then(function(){
          view.render();
          this$.fire('preview.done');
          return this$.fire('file.chosen', lc.files);
        });
      };
      return this.lc.view = view = new ldView({
        root: this.root,
        action: {
          input: {
            input: function(arg$){
              var node, evt, thumb;
              node = arg$.node, evt = arg$.evt;
              thumb = function(list){
                return new Promise(function(res, rej){
                  var ret, _;
                  ret = [];
                  _ = function(list){
                    var file, src, img;
                    file = list.splice(0, 1)[0];
                    if (!file) {
                      return res(ret);
                    }
                    src = URL.createObjectURL(file);
                    img = new Image();
                    img.onload = function(){
                      var ref$, w, h, c1, ctx;
                      ref$ = [img.width, img.height], w = ref$[0], h = ref$[1];
                      if (w > 200) {
                        ref$ = [200, h * 200 / w], w = ref$[0], h = ref$[1];
                      }
                      if (h > 150) {
                        ref$ = [w * 150 / h, 150], w = ref$[0], h = ref$[1];
                      }
                      c1 = document.createElement("canvas");
                      c1.width = w;
                      c1.height = h;
                      ctx = c1.getContext('2d');
                      ctx.drawImage(img, 0, 0, w, h);
                      return c1.toBlob(function(blob){
                        var f;
                        ret.push(f = {
                          thumb: URL.createObjectURL(blob),
                          file: file
                        });
                        preview([f]);
                        return _(list);
                      });
                    };
                    return img.src = src;
                  };
                  return _(list);
                });
              };
              return thumb(Array.from(node.files)).then(function(files){
                var that;
                if (that = node.form) {
                  return that.reset();
                }
              });
            }
          },
          click: {
            upload: function(arg$){
              var node, evt;
              node = arg$.node, evt = arg$.evt;
              return this$.upload().then(function(it){
                this$.clear();
                return it;
              });
            },
            clear: function(arg$){
              var node, evt;
              node = arg$.node, evt = arg$.evt;
              return this$.clear();
            }
          },
          drop: {
            drop: function(arg$){
              var node, evt, promises;
              node = arg$.node, evt = arg$.evt;
              evt.preventDefault();
              this$.fire('preview.loading');
              promises = Array.from(evt.dataTransfer.files).map(function(it){
                return ldFile.fromFile(it, 'dataurl', 'utf-8');
              });
              return Promise.all(promises).then(function(){
                return perview(files);
              });
            }
          },
          dragover: {
            drop: function(arg$){
              var node, evt;
              node = arg$.node, evt = arg$.evt;
              return evt.preventDefault();
            }
          }
        },
        handler: {
          file: {
            list: function(){
              return lc.files || [];
            },
            handle: function(arg$){
              var node, data, view;
              node = arg$.node, data = arg$.data;
              data.node = node;
              return view = new ldView({
                root: node,
                action: {
                  click: {
                    'delete': function(){
                      var idx;
                      node.parentNode.removeChild(node);
                      idx = lc.files.indexOf(data);
                      if (idx >= 0) {
                        return lc.files.splice(idx, 1);
                      }
                    }
                  }
                },
                handler: {
                  name: function(arg$){
                    var node;
                    node = arg$.node;
                    return node.textContent = data.file.name;
                  },
                  size: function(arg$){
                    var node;
                    node = arg$.node;
                    return node.textContent = Math.round(data.file.size / 1024) + "KB";
                  },
                  thumb: function(arg$){
                    var node;
                    node = arg$.node;
                    if (node.nodeName.toLowerCase() === 'img') {
                      return node.setAttribute('src', data.thumb);
                    } else {
                      return node.style.backgroundImage = "url(" + data.thumb + ")";
                    }
                  }
                }
              });
            }
          }
        }
      });
    },
    get: function(){
      return this.lc.files;
    },
    clear: function(){
      this.lc.files.splice(0);
      return this.lc.view.render();
    },
    upload: function(){
      var this$ = this;
      return ext[this.ucfg.host]({
        files: this.lc.files,
        progress: this.progress,
        opt: this.ucfg
      }).then(function(it){
        this$.fire('upload.done', it);
        return it;
      })['catch'](function(it){
        this$.fire('upload.fail', it);
        return Promise.reject(it);
      });
    }
  });
  uploadr.ext = ext = {};
  ext.dummy = function(arg$){
    var files, progress, opt;
    files = arg$.files, progress = arg$.progress, opt = arg$.opt;
    return new Promise(function(res, rej){
      return res(files.map(function(it){
        return {
          url: "https://i.ibb.co/frf90x6/only-support.png",
          name: it.file.name
        };
      }));
    });
  };
  ext.native = function(arg$){
    var files, progress, opt;
    files = arg$.files, progress = arg$.progress, opt = arg$.opt;
    return new Promise(function(res, rej){
      var ref$, merge, route, fd, ret, len, _, this$ = this;
      ref$ = opt || {}, merge = ref$.merge, route = ref$.route;
      progress({
        percent: 0,
        val: 0,
        len: len
      });
      if (merge) {
        fd = new FormData();
        files.map(function(it){
          return fd.append('file', it.file);
        });
        return ld$.xhr(route, (ref$ = {
          method: 'POST',
          body: fd
        }, ref$.headers = opt.headers, ref$), {
          type: 'json'
        }).then(res)['catch'](rej);
      } else {
        ret = [];
        len = files.length;
        _ = function(list){
          var item, fd, ref$;
          item = list.splice(0, 1)[0];
          if (!item) {
            return res(ret);
          }
          fd = new FormData();
          fd.append('file', item.file);
          return ld$.xhr(route, (ref$ = {
            method: 'POST',
            body: fd
          }, ref$.headers = opt.headers, ref$), {
            type: 'json',
            progress: function(it){
              return progress((it.item = item, it));
            }
          }).then(function(it){
            var o;
            ret.push(o = it[0]);
            return _(list);
          })['catch'](function(it){
            var o;
            return ret.push(o = {
              name: item.file.name,
              error: it
            });
          });
        };
        return _(files);
      }
    });
  };
  ext.imgbb = function(arg$){
    var files, progress, opt;
    files = arg$.files, progress = arg$.progress, opt = arg$.opt;
    return new Promise(function(res, rej){
      var ret, len, _, this$ = this;
      ret = [];
      len = files.length;
      progress({
        percent: 0,
        val: 0,
        len: len
      });
      _ = function(list){
        var item, fd;
        item = list.splice(0, 1)[0];
        if (!item) {
          return res(ret);
        }
        fd = new FormData();
        fd.append('image', item.file);
        return ld$.xhr("https://api.imgbb.com/1/upload?key=" + opt.key, {
          method: 'POST',
          body: fd
        }, {
          type: 'json'
        }).then(function(it){
          var o;
          if (!(it && it.data && it.status === 200)) {
            return Promise.reject(it);
          }
          ret.push(o = {
            url: it.data.display_url,
            name: item.file.name,
            id: it.data.id,
            raw: it.data
          });
          progress({
            percent: (len - list.length) / len,
            val: len - list.length,
            len: len,
            item: o
          });
          return _(list);
        })['catch'](function(it){
          var o;
          ret.push(o = {
            name: item.file.name,
            error: it
          });
          return progress({
            percent: (len - list.length) / len,
            val: len - list.length,
            len: len,
            item: o
          });
        });
      };
      return _(files);
    });
  };
  if (that = viewer) {
    uploadr.viewer = that;
  }
  if (typeof module != 'undefined' && module !== null) {
    module.exports = uploadr;
  }
  if (typeof window != 'undefined' && window !== null) {
    return window.uploadr = uploadr;
  }
})();
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
